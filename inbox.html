<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inbox - GigNest</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: #141414;
      color: white;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .header {
      background-color: #1e1e1e;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      font-size: 24px;
    }
    .logout-btn {
      background-color: #fff;
      color: #141414;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .container {
      flex: 1;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
    }
    .conversations {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .conversation {
      background-color: #222;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .conversation:hover {
      background-color: #2c2c2c;
    }
    .conversation.unread {
      border-left: 4px solid #3498db;
    }
    .conversation-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    .conversation-user {
      font-weight: bold;
    }
    .conversation-time {
      color: #aaa;
      font-size: 0.9em;
    }
    .conversation-preview {
      color: #ccc;
      font-size: 0.95em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .message-container {
      display: none;
      flex-direction: column;
      height: 100%;
    }
    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid #333;
      background-color: #1e1e1e;
    }
    .message-back-btn {
      background: none;
      border: none;
      color: #3498db;
      cursor: pointer;
      font-size: 16px;
    }
    .message-body {
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      background-color: #141414;
    }
    .message-input {
      display: flex;
      padding: 10px;
      background-color: #1e1e1e;
      border-top: 1px solid #333;
    }
    .message-input input {
      flex: 1;
      padding: 10px;
      border-radius: 5px;
      border: none;
      background: #333;
      color: white;
    }
    .message-input button {
      background-color: #00b894;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 10px;
    }
    .message {
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 5px;
      background-color: #2c3e50;
      max-width: 70%;
    }
    .message.me {
      margin-left: auto;
      background-color: #00b894;
    }
    .message-sender {
      font-weight: bold;
      color: #00b894;
    }
    .message.me .message-sender {
      color: white;
    }
    .message-time {
      font-size: 0.8em;
      color: #aaa;
      margin-left: 10px;
    }
    .message-text {
      margin-top: 5px;
    }
    .no-conversations {
      text-align: center;
      padding: 20px;
      color: #aaa;
    }
    .loading {
      text-align: center;
      padding: 20px;
    }
    .loading span {
      display: inline-block;
      width: 10px;
      height: 10px;
      margin: 0 2px;
      background-color: #00b894;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }
    .loading span:nth-child(1) {
      animation-delay: -0.32s;
    }
    .loading span:nth-child(2) {
      animation-delay: -0.16s;
    }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <div class="header">
    <a href="main.html"><button class="logout-btn">Come Back</button></a>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <div class="container">
    <div id="conversations-view" class="conversations">
      <div class="loading">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>

    <div id="message-view" class="message-container">
      <div class="message-header">
        <button class="message-back-btn" onclick="showConversations()">‚Üê Back</button>
        <h2 id="current-recipient"></h2>
      </div>
      <div class="message-body" id="message-body">
        <!-- Messages will appear here -->
      </div>
      <div class="message-input">
        <input type="text" id="message-text" placeholder="Type your message...">
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDavL0RmMLSDvwwdEzHwuRx8LEA7u-Rk3M",
      authDomain: "project-lvl3.firebaseapp.com",
      projectId: "project-lvl3",
      storageBucket: "project-lvl3.appspot.com",
      messagingSenderId: "202554438946",
      appId: "1:202554438946:web:dca6ebd6d5b683fe45e17b",
      measurementId: "G-HLMM73VTVY",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUserEmail = "";
    let currentRecipient = "";
    let unsubscribeMessages = null;
    let unsubscribeInbox = null;
    let globalMessageListener = null;

    function getConversationId(user1, user2) {
      return [user1, user2].sort().join('_');
    }

    function showConversations() {
      document.getElementById("conversations-view").style.display = "flex";
      document.getElementById("message-view").style.display = "none";
      if (unsubscribeMessages) unsubscribeMessages();
      loadConversations();
    }

    function markMessagesAsRead(conversationId) {
      // Mark messages as read in Firestore
      db.collection("messages")
        .where("conversationId", "==", conversationId)
        .where("recipient", "==", currentUserEmail)
        .where("read", "==", false)
        .get()
        .then((snapshot) => {
          const batch = db.batch();
          snapshot.forEach(doc => {
            batch.update(doc.ref, { read: true });
          });
          return batch.commit();
        });

      // Mark conversation as read in inbox
      db.collection("inbox")
        .doc(`${currentUserEmail}_${currentRecipient}`)
        .update({ read: true });
    }

    function showMessages(recipient) {
      currentRecipient = recipient;
      document.getElementById("conversations-view").style.display = "none";
      document.getElementById("message-view").style.display = "flex";
      document.getElementById("current-recipient").textContent = recipient;
      document.getElementById("message-body").innerHTML = "";
      
      // Mark messages as read
      markMessagesAsRead(getConversationId(currentUserEmail, recipient));
      
      if (unsubscribeMessages) unsubscribeMessages();
      
      unsubscribeMessages = db.collection("messages")
        .where("conversationId", "==", getConversationId(currentUserEmail, recipient))
        .orderBy("timestamp", "asc")
        .onSnapshot(
          (snapshot) => {
            const messageBody = document.getElementById("message-body");
            messageBody.innerHTML = "";
            
            snapshot.forEach((doc) => {
              const message = doc.data();
              const messageElement = document.createElement("div");
              messageElement.className = `message ${message.sender === currentUserEmail ? 'me' : ''}`;
              
              const time = message.timestamp ? message.timestamp.toDate() : new Date();
              const timeString = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
              
              messageElement.innerHTML = `
                <div class="message-sender">${message.sender === currentUserEmail ? 'You' : message.sender}</div>
                <div class="message-text">${message.text}</div>
                <div class="message-time">${timeString}</div>
              `;
              messageBody.appendChild(messageElement);
            });
            
            messageBody.scrollTop = messageBody.scrollHeight;
          },
          (error) => {
            console.error("Message listener error:", error);
          }
        );
    }

    async function sendMessage() {
      const text = document.getElementById("message-text").value.trim();
      if (!text) return;
      
      const user = auth.currentUser;
      if (!user) return;
      
      const sendBtn = document.querySelector('#message-view button');
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';

      try {
        const conversationId = getConversationId(currentUserEmail, currentRecipient);
        
        await db.collection("messages").add({
          conversationId: conversationId,
          sender: currentUserEmail,
          recipient: currentRecipient,
          text: text,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          read: false
        });
        
        const inboxUpdate = {
          lastMessage: text,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          read: false
        };
        
        await Promise.all([
          db.collection("inbox").doc(`${currentUserEmail}_${currentRecipient}`).set({
            user1: currentUserEmail,
            user2: currentRecipient,
            ...inboxUpdate
          }, { merge: true }),
          
          db.collection("inbox").doc(`${currentRecipient}_${currentUserEmail}`).set({
            user1: currentRecipient,
            user2: currentUserEmail,
            ...inboxUpdate
          }, { merge: true })
        ]);
        
        document.getElementById("message-text").value = "";
      } catch (error) {
        console.error("Error sending message:", error);
        alert("Failed to send message. Please try again.");
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
      }
    }

    function loadConversations() {
      const conversationsView = document.getElementById("conversations-view");
      conversationsView.innerHTML = '<div class="loading"><span></span><span></span><span></span></div>';
      
      if (unsubscribeInbox) unsubscribeInbox();
      
      unsubscribeInbox = db.collection("inbox")
        .where("user1", "==", currentUserEmail)
        .orderBy("timestamp", "desc")
        .onSnapshot(
          (snapshot) => {
            conversationsView.innerHTML = "";
            
            if (snapshot.empty) {
              conversationsView.innerHTML = '<div class="no-conversations">No conversations yet</div>';
              return;
            }
            
            snapshot.forEach((doc) => {
              const conversation = doc.data();
              const conversationElement = document.createElement("div");
              conversationElement.className = `conversation ${conversation.read ? '' : 'unread'}`;
              
              const time = conversation.timestamp ? conversation.timestamp.toDate() : new Date();
              const timeString = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
              
              conversationElement.innerHTML = `
                <div class="conversation-header">
                  <div class="conversation-user">${conversation.user2}</div>
                  <div class="conversation-time">${timeString}</div>
                </div>
                <div class="conversation-preview">${conversation.lastMessage}</div>
              `;
              
              conversationElement.addEventListener("click", () => {
                showMessages(conversation.user2);
              });
              
              conversationsView.appendChild(conversationElement);
            });
          },
          (error) => {
            console.error("Inbox listener error:", error);
            conversationsView.innerHTML = '<div class="no-conversations">Error loading conversations</div>';
          }
        );
    }

    function setupGlobalMessageListener() {
      globalMessageListener = db.collection("messages")
        .where("recipient", "==", currentUserEmail)
        .onSnapshot((snapshot) => {
          snapshot.docChanges().forEach((change) => {
            if (change.type === "added") {
              // Refresh conversations if on conversations view
              if (document.getElementById("conversations-view").style.display !== "none") {
                loadConversations();
              }
              // If viewing a different conversation, show notification
              else if (change.doc.data().sender !== currentRecipient) {
                const notification = document.createElement("div");
                notification.className = "message-notification";
                notification.innerHTML = `New message from ${change.doc.data().sender}`;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
              }
            }
          });
        });
    }

    function logout() {
      if (unsubscribeMessages) unsubscribeMessages();
      if (unsubscribeInbox) unsubscribeInbox();
      if (globalMessageListener) globalMessageListener();
      
      auth.signOut().then(() => {
        window.location.href = "login.html";
      });
    }

    auth.onAuthStateChanged((user) => {
      if (user) {
        currentUserEmail = user.email;
        loadConversations();
        setupGlobalMessageListener();
        
        // Check if we should pre-load a conversation
        const preloadRecipient = sessionStorage.getItem('preloadRecipient');
        if (preloadRecipient) {
          showMessages(preloadRecipient);
          sessionStorage.removeItem('preloadRecipient');
        }
      } else {
        window.location.href = "index.html";
      }
    });

    // Handle Enter key for sending messages
    document.getElementById("message-text").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        sendMessage();
      }
    });
  </script>
</body>
</html>